@*
/account/register/
*@

@using Lumina.Presentation.Web.Common.Models.UsersManagement

@{
    string? registrationType = ViewData["RegistrationType"] as string;
}

@model RegisterRequestModel

<div class="enlightenment-panel shadow-effect p-2 mx-auto panel w-50 mb-10" style="min-width: 320px; margin-top: 1rem;">
    <div class="shine-effect"></div>
    <form asp-controller="Account" asp-action="Register" method="post" id="register-account-form" class="inline">
        @Html.AntiForgeryToken()
        <!-- section for determining registration type (regular user/admin) -->
        <input type="hidden" name="RegistrationType" value="@registrationType" />
        <div class="form-container">
            @if (registrationType == "Admin")
            {
                <div class="form-row">
                    <p class="invalid-feedback w-95 text-center f-18">Admin account registration</p>
                </div>
            }
            <!-- Username -->
            <div class="form-row">
                <div class="form-label">
                    <label asp-for="Username">Username</label>
                    <span class="mandatory-field">*</span>:
                </div>
                <div class="form-field">
                    <input asp-for="Username" autocomplete="username" class="enlightenment-input" />
                </div>
                <small class="form-label text-disabled form-description">DescriptionUsername</small>
            </div>
            <!-- Password -->
            <div class="form-row">
                <div class="form-label">
                    <label asp-for="Password">Password</label>
                    <span class="mandatory-field">*</span>:
                </div>
                <div class="form-field">
                    <input type="password" asp-for="Password" autocomplete="new-password" class="enlightenment-input" />
                </div>
                <small class="form-label text-disabled form-description">DescriptionPassword</small>
            </div>
            <!-- Password Confirm-->
            <div class="form-row">
                <div class="form-label">
                    <label asp-for="PasswordConfirm">Password Confirm</label>
                    <span class="mandatory-field">*</span>:
                </div>
                <div class="form-field">
                    <input type="password" asp-for="PasswordConfirm" autocomplete="new-password" class="enlightenment-input" />
                </div>
                <small class="form-label text-disabled form-description">DescriptionPasswordConfirm</small>
            </div>
            <!-- 2FA -->
            <input type="hidden" id="hiddenUseTwoFa" name="use2fa" value="true">
            <div class="form-row">
                <div class="form-field">
                    <label class="enlightenment-checkbox-label">
                        <input type="checkbox" asp-for="Use2fa" class="enlightenment-checkbox-hidden" value="true" />
                        <span class="enlightenment-checkbox"></span>
                        Enable two factor authentication
                    </label>
                </div>
                <small class="form-label text-disabled form-description">Description2Fa</small>
            </div>
            <div class="form-row">
                <span id="register2FaAttention" class="invalid-feedback w-95 text-center hidden">Password recovery is allowed only if two factor authentication is enabled!</span>
            </div>
            <div class="form-row" style="justify-content: center;">
                <button type="submit" class="confirm-button h-22px w-100px">Register</button>
            </div>
        </div>
    </form>
    <!-- section registration success -->
    <div class="text-center w-100">
        <p id="registerSuccess" class="text-light-one w-100 hidden">Account Created</p>
        <img id="totpImage" class="w-200px h-200px h-align-m mx-auto mt-10 hidden" />
        <p id="totpMessage" class="text-light-one w-100 hidden">Scan Totp Code</p>
        <a id="redirectButton" asp-controller="Account" asp-action="Login" class="confirm-button f-14 pt-0 pb-0 h-22px w-80px mt-10 mb-10 mx-auto hidden">Login</a>
    </div>
</div>
@section Scripts {
    <script type="text/javascript" defer>
        document.getElementById('register-account-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;
            const txtUsername = form.querySelector('[name="Username"]');
            const txtPassword = form.querySelector('[name="Password"]');
            const txtPasswordConfirm = form.querySelector('[name="PasswordConfirm"]');
            const chkUse2FA = form.querySelector('[name="Use2fa"]');
            const registerSuccess = document.getElementById('registerSuccess');
            const redirectButton = document.getElementById('redirectButton');
            const totpMessage = document.querySelector('#totpMessage');
            const totpImage = document.querySelector('#totpImage');
            const formData = {
                Username: txtUsername.value,
                Password: txtPassword.value,
                PasswordConfirm: txtPasswordConfirm.value,
                Use2fa: chkUse2FA.checked,
                RegistrationType: form.querySelector('[name="RegistrationType"]').value
            };
            const data = await callApiPostAsync('/account/register', formData);
            if (data) {
                txtUsername.value = '';
                txtPassword.value = '';
                txtPasswordConfirm.value = '';
                form.classList.replace('inline', 'hidden');
                registerSuccess.classList.replace('hidden', 'inline');
                redirectButton.classList.replace('hidden', 'block');
                if (chkUse2FA.checked) {
                    totpMessage.classList.remove('hidden');
                    totpMessage.classList.add('block');

                    totpImage.classList.remove('hidden');
                    totpImage.classList.add('block');
                    totpImage.setAttribute('src', data.totpSecret);
                }
            }
        });
        document.querySelector('[name="Use2fa"]').addEventListener('change', function () {
            const isChecked = this.checked;
            document.querySelector('#register2FaAttention').classList.replace(
                isChecked ? 'inline' : 'hidden',
                isChecked ? 'hidden' : 'inline'
            );
            document.querySelector('#hiddenUseTwoFa').value = isChecked.toString();
        });
    </script>
}
